Db Keeper is a set of scripts to create deploy package for database using version source control history and database comparison tool. The benefit of such solution is that database developers operate in terms of database model itself as opposed to transitions between states of model and therefore need to care less about writing transitional scripts.

Db Keeper allows to put scripts which create the database from scratch in source control, each object in separate file. Source control will provide history of all changes since time object was created. Since whole snapshot is available then tools which could verify consistency of sources without actually deploying it could be used prior and post commit to the source control. One of the products which provides such feature is Visual Database Tools (http://msdn.microsoft.com/en-us/library/y5a4ezk9.aspx). The database could be deployed by generating comparison script between target database and the snapshot from source control and applying it instantly, however it is very slippery road. The issue is that deployment by comparison is essentially deploying just created delta, which by definition is not tested anywhere. And that is something which has to be avoided by all means since that it is the root of all evil. The solution is to remove deployment by comparison from the equation and use comparison to generate deltas which will eventually be used to update every single environment and be pushed through entire quality assurance routine without changes. There is no need to compare all revisions between each other. It is enough to compare starting with base version and base version with end revision in both directions to produce commit as well as rollback deltas. The revision list could be located in some configuration file and maintained by release engineer. The resulting deltas should be put to the package with structure which can be understood by any deployment tool for farther controlled and automatic deployment.


http://lh3.ggpht.com/-HPOsniAH1J0/UGs1V0r8YKI/AAAAAAAAat4/99graqS3wFo/Image%2525286%252529_thumb%25255B4%25255D.png?imgmax=800


The only drawback is that autogenerated scripts are not always good enough to be used. Consider the case when the column is renamed (lets say the change was added to the source control under version #4). Any conventional comparison tool will generate script to drop column and then add it again under different name, which obviously results in loosing data. Visual Database Tools generate warning in such cases and while it helps to prevent disaster it still obliges developers to change the script manually (MS actually has incorporated mechanism to handle renames, but developer has to always use refactoring tools to do changes). There has to be a possibility to override autogenerated deltas with custom migration, where developers could specify desirable sequence of changes.



http://lh3.ggpht.com/-5lrmfquNwno/UGs1Wo45_II/AAAAAAAAauI/qocE7edXAnw/Image%2525287%252529_thumb%25255B4%25255D.png?imgmax=800



Such approach is used in Red Gate Sql Source Control (http://www.red-gate.com/products/sql-development/sql-source-control/). Although it is a great tool, I did not choose to use it since it doesn't support rollbacks for custom migrations and can not release database to the location where source control is not available.  Instead I've created Db Keeper as powershell scripts which create the package with deltas using source control history and database comparison tool. The output of those scripts is package which can be deployed by db-advance tool (http://code.google.com/p/db-advance/). These scripts can be used as is with minor modifications to create deltas and deploy database from source control with database snapshot sources.